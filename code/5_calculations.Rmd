---
title: "5. Calculations"
author: "Ross Dahlke"
date: "9/27/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
options(scipen = 999)
```

```{r}
ds <- readRDS("~/git/political_donor_motivations/data/candidate_donor_scores.RDA") %>% 
  ungroup()
ts <- readRDS("~/git/political_donor_motivations/data/candidate_topic_scores.RDA") %>% 
  ungroup()

all_targets <- ds %>%
  select(target) %>% 
  rbind(ts %>% 
          select(target)) %>% 
  distinct(target) %>% 
  pull()

all_predicted <- ts %>% 
  distinct(predicted) %>% 
  pull()

all_modularity <- ds %>% 
  distinct(modularity_class) %>% 
  pull()

```


```{r}
results <- expand.grid(target = all_targets,
                    predicted = all_predicted,
                    modularity_class = all_modularity) %>% 
  left_join(ts %>% select(target, predicted, topic_score)) %>% 
  left_join(ds %>% select(target, modularity_class, cluster_score)) %>% 
  filter(!is.na(predicted) | !is.na(modularity_class)) %>% 
  filter(modularity_class <= 12) %>% 
  replace(is.na(.), 0) %>% 
  mutate(cluster_score.quart = cluster_score^(1/10),
       topic_score.quart = topic_score^(1/10)) %>% 
  ungroup() %>% 
  group_by(modularity_class, predicted) %>%
  summarize(correlation = cor.test(cluster_score, topic_score)$estimate,
            p_value = p.adjust(cor.test(cluster_score, topic_score)$p.value, "BH"),
            correlation_quart = cor.test(cluster_score.quart, topic_score.quart)$estimate,
            p_value_quart = p.adjust(cor.test(cluster_score.quart, topic_score.quart)$p.value, "BH")) %>% 
  mutate(significance = if_else(p_value < .05, "significant", "not_significant"),
            significance_quart = if_else(p_value_quart < .05, "significant", "not_significant"),
            correlation_sig = ifelse(significance == "significant", correlation, NA),
            correlation_quart_sig = ifelse(significance_quart == "significant", correlation_quart, NA))

```

```{r}
ggplot(results, aes(modularity_class, predicted, fill=correlation)) +
  geom_raster() +
  scale_fill_distiller(palette="OrRd", direction=1) +
  scale_x_continuous(breaks=seq(0,12,1), position="top") +
  labs(x = "donor cluster",
       y = "topic",
       fill = "correlation") +
  theme_minimal()

```

```{r}
ggplot(results, aes(modularity_class, predicted, fill=significance)) +
  geom_raster() +
  scale_x_continuous(breaks=seq(0,12,1), position="top") +
  labs(x = "donor cluster",
       y = "topic",
       fill = "significance") +
  theme_minimal()

```


```{r}
ggplot(results, aes(modularity_class, predicted, fill=correlation_sig)) +
  geom_raster() +
  scale_fill_distiller(palette="OrRd", direction=1) +
  scale_x_continuous(breaks=seq(0,12,1), position="top") +
  labs(x = "donor cluster",
       y = "topic",
       fill = "correlation") +
  theme_minimal()

```

