---
title: "5. Calculations"
author: "Ross Dahlke"
date: "9/27/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(parallel)
library(doParallel)
options(scipen = 999)
```

```{r}
donations <- read_csv("~/git/political_donor_motivations/data/2016_donations_clusters_all.csv")
uncoded_predicted <- read_csv("~/git/political_donor_motivations/data/uncoded_predicted.csv")
```

```{r}
n_clusters <- donations %>% 
  # filter(modularity_class <= 12) %>% 
  distinct(modularity_class) %>% 
  count() %>% 
  pull(n)

n_topics <- uncoded_predicted %>% 
  distinct(predicted) %>% 
  count() %>% 
  pull(n)

p_adjustments <- n_clusters * n_topics * 2
```


```{r}
granger_model <- function(cluster,
                          topic,
                          donation_per_threshold = .01,
                          adjustments = p_adjustments){

campaigns <- donations %>% 
  filter(modularity_class == cluster) %>%
  count(target) %>% 
  mutate(per = n / sum(n)) %>% 
  filter(per >= donation_per_threshold) %>% 
  pull(target)

posts_by_topic <- uncoded_predicted %>% 
  filter(target %in% campaigns) %>% 
  group_by(predicted, date) %>% 
  summarize(topic_count = n()) %>% 
  mutate(date = lubridate::mdy(date)) %>% 
  arrange(date)

cluster_donations <- donations %>% 
  filter(modularity_class == cluster) %>% 
  group_by(modularity_class, date) %>% 
  summarize(donation_count = n(),
            donation_amount = sum(contribution)) %>% 
  mutate(date = lubridate::mdy(date)) %>% 
  arrange(date) %>% 
  ungroup()

granger_data <- tibble(date = seq.Date(as.Date("2015-01-01"), as.Date("2016-11-06"), by = 1)) %>% 
  left_join(cluster_donations) %>%  
  left_join(posts_by_topic %>% 
              filter(predicted == topic)) %>% 
  select(date, topic_count, donation_count, donation_amount) %>% 
  mutate_if(is.numeric, replace_na, replace = 0)

best_lag <- tsDyn::lags.select(granger_data %>% select(topic_count, donation_count), lag.max = 8)
order <-  best_lag$BIC_min[2]

if(sum(granger_data$topic_count) == 0 | sum(granger_data$donation_count) == 0){
  
  output <- tibble(cluster = cluster,
       topic = topic,
       result = "no relationship detected",
       lag = c(order))
  
  return(output)
}
  
access_model <- lmtest::grangertest(diff(granger_data$topic_count) ~ diff(granger_data$donation_count), order = order) %>% 
  tibble() %>% 
  filter(row_number() == 2) %>% 
  mutate(model = "access")

consumption_model <- lmtest::grangertest(diff(granger_data$donation_count) ~ diff(granger_data$topic_count), order = order) %>% 
  tibble() %>% 
  filter(row_number() == 2) %>% 
  mutate(model = "consumption")
  
results <- access_model %>% 
  rbind(consumption_model) %>% 
  janitor::clean_names() %>% 
  mutate(modularity_class = cluster,
         topic = topic,
         adjusted_pr_f = p.adjust(pr_f, method = "bonferroni", n = adjustments)) %>% 
  filter(adjusted_pr_f < .05) 

if(nrow(results) == 0){
  result <- "no relationship detected"
}

if(nrow(results) == 1){
  result <- results %>% pull(model)
}

if(nrow(results) == 2){
  result <- "confounder"
}

output <- tibble(cluster = c(cluster),
       topic = c(topic),
       result = c(result),
       lag = c(order))
  
return(output)

}
```

```{r}
topics <- uncoded_predicted %>% distinct(predicted) %>% pull()
modularity_classes <- donations %>% 
  # filter(modularity_class <= 12) %>%  
  distinct(modularity_class) %>% arrange(modularity_class) %>% pull() 
```

```{r}
n_cores <- detectCores()

registerDoParallel(makeCluster(n_cores - 1))
```

```{r}
granger_results <- foreach(cluster = modularity_classes,
                           .packages = c("dplyr", "tidyr"),
                           .errorhandling = c("pass"),
                           .combine = "rbind") %:%
  foreach(topic = topics,
          .packages = c("dplyr", "tidyr"),
          .errorhandling = c("pass"),
          .combine = "rbind") %dopar%
  granger_model(cluster = cluster,
          topic = topic)

```

```{r}
plot <- granger_results %>% 
  mutate(result = factor(result, c("access", "consumption", "confounder", "no relationship detected"))) %>% 
  ggplot(aes(cluster, topic, fill = result)) +
  geom_raster() +
  scale_x_continuous(breaks = seq(0, 40, 1), position = "top") +
  scale_fill_grey() +
  labs(x = "donor coalition",
       y = "topic",
       fill = "donor motivation model",
       caption = "p-values adjusted with Holm's method") +
  theme_bw() +
  theme(legend.position = "bottom") +
  guides(fill = guide_legend(nrow = 2))
```

```{r}
ggsave("../tables_and_figures/aejmc_abstract_1.jpg", plot, height = 7.1, width = 7.1)
```

```{r}
granger_results %>% 
  write_csv("../data/granger_results.csv")
```

# Contributor size

```{r}
cluster_category <- granger_results %>% 
  group_by(cluster) %>% 
  summarize(category = case_when(
    any(result == "access") ~ "access",
    any(result == "consumption") ~ "consumption",
    any(result == "confounder") ~ "confounder",
    TRUE ~ "0_no_relationship"
  ))
```


```{r}
donor_totals <- donations %>% 
  group_by(source, modularity_class) %>% 
  summarize(total_contributed = sum(contribution, na.rm = T),
            n_contributed = n()) %>% 
  left_join(cluster_category, by = c("modularity_class" = "cluster")) %>% 
  filter(n_contributed > 1)
```

```{r}
lm(total_contributed ~ category, data = donor_totals) %>% 
  summary()
```

```{r}
lm(n_contributed ~ category, data = donor_totals) %>% 
  summary()
```

