---
title: "5. Calculations"
author: "Ross Dahlke"
date: "9/27/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(parallel)
library(doParallel)
options(scipen = 999)
```

```{r}
donations <- read_csv("~/git/political_donor_motivations/data/2016_donations_w_clusters.csv")
uncoded_predicted <- read_csv("~/git/political_donor_motivations/data/uncoded_predicted.csv")
```

```{r}
n_clusters <- donations %>% 
  filter(modularity_class <= 12) %>% 
  distinct(modularity_class) %>% 
  count() %>% 
  pull(n)

n_topics <- uncoded_predicted %>% 
  distinct(predicted) %>% 
  count() %>% 
  pull(n)

p_adjustments <- n_clusters * n_topics
```


```{r}
granger_model <- function(cluster,
                          topic,
                          donation_per_threshold = .01,
                          adjustments = p_adjustments){

campaigns <- donations %>% 
  filter(modularity_class == cluster) %>%
  count(target) %>% 
  mutate(per = n / sum(n)) %>% 
  filter(per >= donation_per_threshold) %>% 
  pull(target)

posts_by_topic <- uncoded_predicted %>% 
  filter(target %in% campaigns) %>% 
  group_by(predicted, date) %>% 
  summarize(topic_count = n()) %>% 
  mutate(date = lubridate::mdy(date)) %>% 
  arrange(date)

cluster_donations <- donations %>% 
  filter(modularity_class == cluster) %>% 
  group_by(modularity_class, date) %>% 
  summarize(donation_count = n(),
            donation_amount = sum(contribution)) %>% 
  mutate(date = lubridate::mdy(date)) %>% 
  arrange(date) %>% 
  ungroup()

granger_data <- tibble(date = seq.Date(as.Date("2015-01-01"), as.Date("2016-11-06"), by = 1)) %>% 
  left_join(cluster_donations) %>%  
  left_join(posts_by_topic %>% 
              filter(predicted == topic)) %>% 
  select(date, topic_count, donation_count, donation_amount) %>% 
  mutate_if(is.numeric, replace_na, replace = 0)

best_lag <- tsDyn::lags.select(granger_data %>% select(topic_count, donation_amount), lag.max = 8)
order <-  best_lag$BIC_min[2]

if(sum(granger_data$topic_count) == 0 | sum(granger_data$donation_amount) == 0){
  
  output <- tibble(cluster = cluster,
       topic = topic,
       result = "no relationship detected",
       lag = c(order))
  
  return(output)
}
  
access_model <- lmtest::grangertest(diff(granger_data$topic_count) ~ diff(granger_data$donation_amount), order = order) %>% 
  tibble() %>% 
  filter(row_number() == 2) %>% 
  mutate(model = "access")

consumption_model <- lmtest::grangertest(diff(granger_data$donation_amount) ~ diff(granger_data$topic_count), order = order) %>% 
  tibble() %>% 
  filter(row_number() == 2) %>% 
  mutate(model = "consumption")
  
results <- access_model %>% 
  rbind(consumption_model) %>% 
  janitor::clean_names() %>% 
  mutate(modularity_class = cluster,
         topic = topic,
         adjusted_pr_f = p.adjust(pr_f, method = "holm", n = adjustments)) %>% 
  filter(adjusted_pr_f < .05) 

if(nrow(results) == 0){
  result <- "no relationship detected"
}

if(nrow(results) == 1){
  result <- results %>% pull(model)
}

if(nrow(results) == 2){
  result <- "confounder"
}

output <- tibble(cluster = c(cluster),
       topic = c(topic),
       result = c(result),
       lag = c(order))
  
return(output)

}
```

```{r}
topics <- posts_by_topic %>% distinct(predicted) %>% pull()
modularity_classes <- donations %>% filter(modularity_class <= 12) %>%  distinct(modularity_class) %>% arrange(modularity_class) %>% pull() 
```

```{r}
n_cores <- detectCores()

registerDoParallel(makeCluster(n_cores - 1))
```

```{r}
granger_results_amount <- foreach(cluster = modularity_classes,
                           .packages = c("dplyr", "tidyr"),
                           .errorhandling = c("pass"),
                           .combine = "rbind") %:%
  foreach(topic = topics,
          .packages = c("dplyr", "tidyr"),
          .errorhandling = c("pass"),
          .combine = "rbind") %dopar%
  granger_model(cluster = cluster,
          topic = topic)

```



